# Fase 1b: CVE Research & Exploit Hunting
## Target: {{TARGET}} ({{TARGET_IP}})

> Input: `deliverables/01_pre_recon.md` (vers√µes de software)
> Output: `deliverables/01b_cve_research.md`

---

## ‚ö†Ô∏è Contexto: Perguntar antes de executar
> Antes de iniciar esta fase, confirmar: **HTB/CTF** ou **Real/Autorizado**?
> Em HTB: testar agressivamente. Em Real: validar escopo antes de exploitar.

## Papel
Pesquisador de vulnerabilidades conhecidas. Correla√ß√£o vers√£o‚ÜíCVE‚Üíexploit‚Üíteste.
Miss√£o: para CADA software/vers√£o encontrado, buscar CVEs, entender o impacto, encontrar exploits p√∫blicos e TESTAR ‚Äî mesmo que a vers√£o pare√ßa patcheada.

## Regras de Ouro
- **Vers√£o patcheada N√ÉO significa seguro** ‚Äî patches podem ser incompletos, backports mal feitos, ou config exposta.
- **Sempre testar** ‚Äî CVE listing √© teoria, exploit execution √© prova.
- **Documentar tudo** ‚Äî inclusive tentativas que falharam (prova de dilig√™ncia).
- **CVEs v√™m em CADEIAS** ‚Äî ao encontrar um CVE, SEMPRE pesquisar na web se h√° CVEs companion/relacionados. Advisories frequentemente descrevem 2+ vulns que se combinam (ex: unprivileged‚Üíallow_active + allow_active‚Üíroot).
- **searchsploit N√ÉO √© suficiente** ‚Äî SEMPRE complementar com busca web (NVD, SOCRadar, Qualys advisories, oss-security, blogs). searchsploit pode ter o exploit mas n√£o explicar a cadeia completa.
- **Analisar o advisory COMPLETO** ‚Äî n√£o apenas o t√≠tulo/descri√ß√£o. Ler o advisory original para entender pr√©-requisitos, cadeias, e PoC detalhado.
- **ENUMERAR TODOS antes de explorar UM** ‚Äî n√£o pegar o primeiro CVE que parece promissor. Listar TODOS os advisories que afetam a vers√£o, criar tabela com pr√©-requisitos e viabilidade, e s√≥ depois escolher. Ver Se√ß√£o 2b abaixo.
- **NUNCA confiar em CVEs "lembrados" pelo agente** ‚Äî o LLM pode fabricar/alucinar n√∫meros de CVE. TODA refer√™ncia deve ser validada com fetch real (NVD, GitHub Advisory) antes de qualquer a√ß√£o. Se o fetch retornar 404 ‚Üí CVE √© FICT√çCIO.

---

## Metodologia

### 1. Invent√°rio de Vers√µes (do Pre-Recon)
Montar tabela com TUDO que tem vers√£o identificada:

```
| Software | Vers√£o | Fonte |
|----------|--------|-------|
| nginx | X.X.X | nmap + headers |
| PHP | X.X.X | phpinfo / X-Powered-By |
| OpenSSH | X.X | nmap |
| CMS/Painel | X.X.X | changelog / fingerprint |
| MySQL/MariaDB | X.X.X | nmap / changelog |
| Framework | ? | fingerprint via cookies |
```

### 2. Pesquisa de CVEs (para cada software)

#### ‚ö†Ô∏è 2b. ENUMERA√á√ÉO EXAUSTIVA (obrigat√≥ria antes de qualquer exploit)

Antes de construir qualquer exploit, fazer enumera√ß√£o completa:

```bash
# 1. GitHub Security Advisories (fonte prim√°ria para projetos open-source)
# Fetch: https://github.com/<vendor>/<product>/security/advisories
# Exemplos:
#   https://github.com/Cacti/cacti/security/advisories
#   https://github.com/WordPress/wordpress/security/advisories

# 2. Filtrar por vers√£o do alvo
# Manter APENAS advisories que afetam a vers√£o instalada

# 3. Criar tabela de triagem:
```

| CVE | GHSA | Tipo | Vers√µes Afetadas | Pr√©-requisitos | User Tem Permiss√£o? | Prioridade |
|-----|------|------|-----------------|----------------|---------------------|------------|
| CVE-2025-XXXX | GHSA-xxxx | RCE | <= 1.2.28 | Auth + host.php | SIM | **ALTA** |
| CVE-2025-YYYY | GHSA-yyyy | SQLi | <= 1.2.28 | Auth + automation | N√ÉO (denied) | DESCARTADO |

```
# 4. Validar CADA CVE com fetch real
# N√ÉO confiar em mem√≥ria do agente ‚Äî fazer fetch de:
#   https://nvd.nist.gov/vuln/detail/CVE-XXXX-YYYY
#   https://github.com/advisories/GHSA-xxxx-xxxx-xxxx
# Se retornar 404 ‚Üí CVE FABRICADO, descartar imediatamente

# 5. Priorizar por viabilidade (n√£o por CVSS)
# CVSS Alto + sem permiss√£o = in√∫til
# CVSS M√©dio + com permiss√£o + exploit p√∫blico = prioridade
```

**Li√ß√£o aprendida:** Na MonitorsFour, o agente fabricou CVE-2025-66399 (n√£o existe),
gastou tempo com CVE-2024-25641 (patcheado na vers√£o do alvo), e demorou para
encontrar CVE-2025-24367 que era vi√°vel. Enumera√ß√£o exaustiva resolveria em minutos.

#### Fontes (em ordem de prioridade):
1. **searchsploit** (local, r√°pido):
   ```bash
   searchsploit <software> <vers√£o>
   searchsploit nginx X.XX
   searchsploit php X.X
   searchsploit openssh X
   searchsploit mysql X
   searchsploit <framework>
   ```

2. **NVD / CVE databases** (web):
   - https://nvd.nist.gov/vuln/search ‚Äî buscar por CPE ou keyword
   - https://www.cvedetails.com/ ‚Äî buscar por produto + vers√£o
   - https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=PRODUTO

3. **GitHub** (exploits p√∫blicos):
   ```bash
   # Buscar no GitHub por exploits
   # Padr√£o: "CVE-XXXX-YYYY" + produto
   # Ou: "produto exploit RCE"
   ```
   - https://github.com/search?q=<PRODUTO>+exploit&type=repositories
   - https://github.com/search?q=CVE+<PRODUTO>&type=repositories
   - https://poc-in-github.motikan2010.net/ ‚Äî agregador de PoCs

4. **Google Dorking**:
   ```
   "<PRODUTO>" exploit OR CVE OR RCE OR vulnerability
   "<PRODUTO> <VERS√ÉO>" CVE
   "<PRODUTO>" CVE RCE
   ```

5. **Exploit-DB** (web):
   - https://www.exploit-db.com/search?q=PRODUTO

### 3. An√°lise de Cada CVE Encontrado

Para cada CVE, documentar:

```markdown
### CVE-XXXX-YYYY
- **Software:** [nome + vers√£o afetada]
- **Tipo:** RCE / SQLi / Auth Bypass / Info Disclosure / DoS / SSRF / LPE / XSS
- **CVSS Score:** X.X
- **Vers√µes afetadas:** X.X.X at√© Y.Y.Y
- **Nossa vers√£o:** Z.Z.Z ‚Äî √© afetada? [SIM/N√ÉO/INCERTO]
- **Descri√ß√£o:** [o que faz em 1-2 linhas]
- **Pr√©-requisitos:** [auth requerida? config espec√≠fica? allow_active?]
- **CVEs relacionados/companion:** [CVE-XXXX-ZZZZ ‚Äî descri√ß√£o da rela√ß√£o]
- **Advisory original:** [URL do advisory completo ‚Äî Qualys, oss-security, etc.]
- **Exploit p√∫blico:** [URL do PoC/exploit]
- **Status:** ‚¨ú N√£o testado | üîÑ Testando | ‚úÖ Confirmado | ‚ùå N√£o vulner√°vel
```

> **‚ö†Ô∏è REGRA OBRIGAT√ìRIA: Pesquisa Web para CADA CVE encontrado**
>
> Ao encontrar um CVE via searchsploit ou qualquer fonte:
> 1. **NVD:** `https://nvd.nist.gov/vuln/detail/CVE-XXXX-YYYY` ‚Äî ler descri√ß√£o + references
> 2. **Google:** `"CVE-XXXX-YYYY"` ‚Äî blogs, advisories, write-ups
> 3. **SOCRadar/Qualys/etc:** buscar an√°lises detalhadas que mostrem cadeias
> 4. **oss-security:** `site:openwall.com CVE-XXXX-YYYY` ‚Äî advisories originais
> 5. **References do NVD:** clicar em CADA link de refer√™ncia ‚Äî advisories completos
>
> **Motivo:** searchsploit mostra o exploit isolado. A web mostra a CADEIA.
> Exemplo real: searchsploit mostrou CVE-2025-6018 (PAM env injection),
> mas s√≥ a pesquisa web revelou que CVE-2025-6019 (udisks XFS resize‚Üíroot)
> √© o companion CVE que completa a cadeia unprivileged‚Üíroot.

### 4. Teste de Exploits

#### 4a. Nuclei (scan automatizado)
```bash
# Scan geral com templates de CVE
nuclei -u http://{{TARGET}} -t cves/ -severity critical,high -o evidence/nuclei_cve_results.txt

# Scan espec√≠fico por tecnologia
nuclei -u http://{{TARGET}} -tags nginx,php,laravel -o evidence/nuclei_tech_results.txt

# Scan no painel (se aplic√°vel)
nuclei -u http://panel.{{TARGET}} -t cves/ -severity critical,high,medium -o evidence/nuclei_panel_results.txt

# Templates custom se necess√°rio
nuclei -u http://{{TARGET}} -t /path/to/custom-template.yaml
```

#### 4b. Exploits Manuais
Para cada CVE com exploit p√∫blico:
- [ ] **Ler e entender o exploit** antes de executar (n√£o rodar cegamente)
- [ ] Verificar se os pr√©-requisitos est√£o presentes
- [ ] Adaptar o exploit ao alvo (URLs, paths, vers√µes)
- [ ] Executar em modo de teste/valida√ß√£o primeiro
- [ ] Se funcionar: capturar evid√™ncia completa
- [ ] Se falhar: documentar o motivo (patcheado? config diferente? WAF?)

#### 4c. Searchsploit + mirror
```bash
# Copiar exploit para pasta local
searchsploit -m EXPLOIT_ID
# Analisar o c√≥digo
cat EXPLOIT_FILE
# Adaptar e executar (se aplic√°vel)
```

### 5. Testar Mesmo com Vers√µes "Patcheadas"

Motivos para testar mesmo assim:
- **Backport incompleto** ‚Äî distro pode n√£o ter patcheado tudo
- **Patch bypass** ‚Äî CVEs frequentemente ganham variantes (CVE-A ‚Üí CVE-B)
- **Configura√ß√£o exposta** ‚Äî fix pode requerer config manual p√≥s-update
- **Falso versionamento** ‚Äî banner pode mostrar vers√£o errada

Abordagem:
- [ ] Testar o exploit mesmo que a vers√£o "n√£o esteja na range"
- [ ] Testar varia√ß√µes do exploit (encoding, paths alternativos)
- [ ] Verificar se a mitiga√ß√£o foi aplicada (n√£o apenas a vers√£o)

---

## Ferramentas por Contexto

| Ferramenta | HTB/CTF | Real |
|------------|---------|------|
| searchsploit | ‚úÖ | ‚úÖ |
| nuclei (cves/) | ‚úÖ | ‚úÖ (com cuidado) |
| GitHub PoCs | ‚úÖ | ‚úÖ (ler antes) |
| Google dorking | ‚úÖ | ‚úÖ |
| NVD/CVE web | ‚úÖ | ‚úÖ |
| Exploit-DB | ‚úÖ | ‚úÖ |
| Metasploit | ‚ö†Ô∏è (se necess√°rio) | ‚úÖ (com autoriza√ß√£o) |

---

## Formato do Deliverable ‚Üí `deliverables/01b_cve_research.md`

```markdown
# CVE Research Report: {{TARGET}}

## 1. Software Inventory
| Software | Vers√£o | Fonte de Detec√ß√£o |

## 2. CVEs Identificados (por criticidade)

### Critical
#### CVE-XXXX-YYYY ‚Äî [T√≠tulo]
- Software / Vers√£o / CVSS / Tipo
- Exploit: [URL]
- Status: ‚úÖ Confirmado / ‚ùå N√£o vulner√°vel / ‚¨ú N√£o testado

### High
...

### Medium
...

## 3. Exploits Testados

### Bem-sucedidos
| CVE | Software | T√©cnica | Impacto | Evid√™ncia |

### Falhos (mas tentados)
| CVE | Software | T√©cnica | Motivo da Falha |

## 4. Nuclei Results
[Output do nuclei scan]

## 5. Recomenda√ß√µes para Pr√≥ximas Fases
[CVEs confirmados alimentam diretamente as fases 4a-4e]
```

---

## üîÄ Decision Point: Pivotar ou Continuar?

Ao encontrar uma vulnerabilidade confirmada nesta fase, a decis√£o depende do **contexto**:

### HTB/CTF: Fast Pivot (priorizar cadeia de explora√ß√£o)

Quando um achado significativo √© confirmado:

1. **Criar pasta de achado** em `deliverables/chains/`:
   ```
   deliverables/chains/CVE-XXXX-YYYY/
   ‚îú‚îÄ‚îÄ finding.md          # Descri√ß√£o do achado
   ‚îú‚îÄ‚îÄ evidence/           # Outputs, responses, screenshots
   ‚îî‚îÄ‚îÄ exploit_chain.md    # Cadeia de explora√ß√£o em constru√ß√£o
   ```

2. **Avaliar exploitabilidade direta:**
   - **Diretamente explor√°vel** (RCE, Auth Bypass, DB creds vazadas, etc.):
     ‚Üí **PIVOTAR IMEDIATAMENTE** para a cadeia de explora√ß√£o. Parar fase 1b.
     ‚Üí Seguir o achado at√© onde ele levar (shell, privesc, flag).
   
   - **N√£o diretamente explor√°vel** (LFI, Info Disclosure, config leak, etc.):
     ‚Üí **ANTES de continuar pesquisando mais CVEs**, revisar TODOS os achados anteriores.
     ‚Üí Cruzar informa√ß√µes para montar cadeia combinada.
     ‚Üí Exemplo: `phpinfo.php` revela `register_argc_argv = On` + PEAR no include_path
       ‚Üí sozinhos n√£o fazem nada, **combinados** = RCE via PEAR cmd injection.
     ‚Üí Se a combina√ß√£o gerar exploit chain vi√°vel ‚Üí **PIVOTAR**.
     ‚Üí Se n√£o ‚Üí continuar fase 1b com os pr√≥ximos softwares.

3. **Princ√≠pio:** Em CTF, tempo √© recurso escasso. N√£o gastar tempo avaliando 
   mais CVEs quando j√° tem uma cadeia de explora√ß√£o vi√°vel nas m√£os.

### Real/Autorizado: An√°lise Completa Primeiro

Em engagement real, a abordagem √© diferente:

1. **Continuar a an√°lise completa** de todos os softwares mesmo ap√≥s achar vulns.
2. **Documentar todos os achados** ‚Äî o cliente precisa do relat√≥rio completo.
3. **Ao final da fase**, combinar achados anteriores + novos para identificar cadeias.
4. **Ent√£o** pivotar para explora√ß√£o de forma organizada.

> Em Real: completude > velocidade. Em CTF: velocidade > completude.

### Checklist de Combina√ß√£o de Achados

Ao encontrar algo "n√£o diretamente explor√°vel", revisar:
- [ ] **phpinfo.php** ‚Äî `register_argc_argv`, `disable_functions`, `open_basedir`, `allow_url_*`
- [ ] **Vers√µes de software** ‚Äî CVEs que requerem condi√ß√µes espec√≠ficas (que talvez j√° existam)
- [ ] **Credenciais vazadas** ‚Äî podem desbloquear auth para outro CVE
- [ ] **Paths internos** revelados ‚Äî `/var/www/...` + LFI = leitura de c√≥digo
- [ ] **Configs de servi√ßo** ‚Äî Redis sem senha, DB local, SMTP aberto
- [ ] **Subdom√≠nios/vhosts** ‚Äî achado em um pode habilitar ataque em outro

---

## Integra√ß√£o com Outras Fases

- **CVEs de Auth** (bypass, default creds) ‚Üí alimentam Fase 3a/4a
- **CVEs de Injection** (SQLi, RCE) ‚Üí alimentam Fase 3c/4c
- **CVEs de XSS** ‚Üí alimentam Fase 3d/4d
- **CVEs de SSRF** ‚Üí alimentam Fase 3e/4e
- **CVEs de RCE direto** ‚Üí podem pular para explora√ß√£o imediata
- **Cadeias combinadas** ‚Üí `deliverables/chains/` com exploit path documentado
